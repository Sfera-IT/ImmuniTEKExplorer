<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        body
        {
            font-family: 'Lato', sans-serif;
        }

        .docs
        {
            box-shadow:0px 0px 0.5em gray;
            padding:1em;
            margin:1em;
        }
    </style>

</head>

<body>
    <!--
I dati di oggi non vanno considerati definitivi fino alla mezzanotte <br />
Totale TEK caricate dal 18 agosto ad oggi: <?php echo $totKeys; ?> <br />
Stima positivi dal 18 agosto ad oggi (TEK/14): <?php echo $totKeys/14; ?> <br />
Visualizzazioni di questa pagina: <?php echo explode(" ", exec('wc -l ./charthits.txt'))[0]; ?>
-->

<div class="chart">
    <canvas id="chart1"></canvas>
</div>

<div class="tek">
    <canvas id="tek"></canvas>
</div>
<div class="perc_positive">
    <canvas id="perc_positive"></canvas>
</div>
<div class="new_cases">
    <canvas id="new_cases"></canvas>
</div>


<div class="docs">    
    Origine dati:
    <ul>
        <li>Parser dei TEK di Immuni, SwissCovid, NHS, CoronaWarnApp</li>
        <li><a href='https://covid.ourworldindata.org/'>Data on COVID-19 (coronavirus) by <i>Our World in Data</i></a></li>
    </ul>
</div>

<div class="docs">
    Dati che abbiamo raccolto per ogni giorno in ogni paese, per riflettere su correlazioni o grafici da aggiungere:
    <ul>
        <li>N. di Tek (da analisi endpoint delle varie app</li>
        <li>total_cases (da OWID)</li>
        <li>new_cases (da OWID)</li>
        <li>total_deaths (da OWID)</li>
        <li>new_deaths (da OWID)</li>
    </ul>
    (ometto dei dati da OWID calcolati come 'smoothed', o '_per_million')
</div>



<script>


function buildCharts(fullData)
{
    new Chart(document.getElementById("tek").getContext("2d"), {
        type: 'line',
        data: {
            datasets: fullData["charts"]["tek"]["datasets"]
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }]
            }
        }
    });    

    new Chart(document.getElementById("perc_positive").getContext("2d"), {
        type: 'line',
        data: {
            datasets: fullData["charts"]["perc_positive"]["datasets"]
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }]
            }
        }
    });

    new Chart(document.getElementById("new_cases").getContext("2d"), {
        type: 'line',
        data: {
            datasets: fullData["charts"]["new_cases"]["datasets"]
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }]
            }
        }
    });
}

function initDatasetCountry(countryData)
{
    var dataset = {}
    dataset.label = countryData.name;
    dataset.backgroundColor = countryData.backgroundColor;
    dataset.borderColor = countryData.borderColor;
    dataset.data = [];
    dataset.borderWidth = 1;
    return dataset;
}

function buildDatasets(chart, data)
{    
    for(var countryCode in data.static.countries)
    {
        var countryData = data.static.countries[countryCode];
        console.log(countryData);
        
        {
            // new_cases
            var dataset = initDatasetCountry(countryData);
            dataset.label = dataset.label + " New Cases";
            
            for(var day in data.days)
            {
                if("new_cases" in data.days[day][countryCode])
                    dataset.data.push({'x':day,'y':data.days[day][countryCode]["new_cases"]})
            }

            console.log(dataset)

            chart.data.datasets.push(dataset)
        }
    }

    chart.update();
}

function main()
{
    var chart1 = new Chart(document.getElementById("chart1").getContext("2d"), {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }]
            }
        }
    });    

    $.ajax({
      url: 'data2/current.json',
      method: 'GET',
      success: function(data) {
        console.log(data);
        buildCharts(data);
        buildDatasets(chart1, data);
      },
      error: function() {
        console.log('Fail, sorry.');
      }
    });
}

main();
    

</script>
</body>
</html>
