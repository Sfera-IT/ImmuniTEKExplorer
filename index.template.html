<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        body
        {
            font-family: 'Lato', sans-serif;
            margin:0.1em;
        }

        .toolbar
        {
            text-align:center;
        }

        .docs, .docs_important
        {
            box-shadow:0px 0px 0.1em gray;
            padding:1em;
            margin:0em;
        }

        .docs_important
        {
            text-align:center;
            background-color:#ffffaa;            
        }
    </style>

</head>

<body>
    <!--
I dati di oggi non vanno considerati definitivi fino alla mezzanotte <br />
Totale TEK caricate dal 18 agosto ad oggi: <?php echo $totKeys; ?> <br />
Stima positivi dal 18 agosto ad oggi (TEK/14): <?php echo $totKeys/14; ?> <br />
Visualizzazioni di questa pagina: <?php echo explode(" ", exec('wc -l ./charthits.txt'))[0]; ?>
-->

<div class="toolbar">
    <select id="chartType">
        <option value="tek">Tek</option>
        <option value="new_cases">New cases</option>
        <option value="perc_positive_v1">% installation (estimated v1)</option>
        <option value="dbkeys">dbkeys</option>        
        <option value="app_download">app_download</option>        
        <option value="app_notifications_sent">app_notifications_sent</option>        
        <option value="app_positive_users">app_positive_users</option>        
    </select>
    <select id="timeRange">
        <option value="31days">Last 31 days</option>
        <option value="7days">Last 7 days</option>        
        <option value="all">All</option>
    </select>
    <div id='chartDesc'>        
    </div>
</div>

<div class="chart">
    <canvas id="chart1"></canvas>
</div>

<div class="docs_important">
    Questo progetto Ã¨ in sviluppo attivo/studio, dati NON affidabili.
    <br>
    I dati SwissCovid sono di certo errati, abbiamo problemi a recuperare tutti i TEK.
</div>

<div class="docs">    
    Origine dati:
    <ul>
        <li>Parser dei TEK di Immuni, SwissCovid, NHS, CoronaWarnApp</li>
        <li><a href='https://covid.ourworldindata.org/'>Data on COVID-19 (coronavirus) by <i>Our World in Data</i></a></li>
    </ul>
</div>

<div class="docs">
    Dati che abbiamo raccolto per ogni giorno in ogni paese, per riflettere su correlazioni o grafici da aggiungere:
    <ul>
        <li>N. di Tek (da analisi endpoint delle varie app</li>
        <li>total_cases (da OWID)</li>
        <li>new_cases (da OWID)</li>
        <li>total_deaths (da OWID)</li>
        <li>new_deaths (da OWID)</li>
    </ul>
    (ometto dei dati da OWID calcolati come 'smoothed', o '_per_million')
</div>

<div class="docs">
    Tech:
    <ul>
        <li>Il job gira ogni ora. <a href='data/log.txt'>Ultimo log</a></li>
    </ul>
</div>



<script>

var data = null;
var chart = null;

function initDatasetCountry(countryData)
{
    var dataset = {}
    dataset.label = countryData.name;
    dataset.backgroundColor = countryData.backgroundColor;
    dataset.borderColor = countryData.borderColor;
    dataset.data = [];
    dataset.borderWidth = 1;
    return dataset;
}

function rebuild()
{
    var chartType = $('#chartType').val();

    if(chartType == "tek")
    {
        $("#chartDesc").text("TEK raccolte dalle App di Contact-Tracing Digitale");
    }
    else if(chartType == "new_cases")
    {
        $("#chartDesc").text("Nuovi casi");
    }
    else if(chartType == "perc_positive_v1")
    {
        $("#chartDesc").text("(nTek / 12) inteso come positivi che avevano l'app, in rapporto ai nuovi casi");
    }
    else if(chartType == "dbkeys")
    {
        $("#chartDesc").text("test");
    }
    else if(chartType == "app_download")
    {
        $("#chartDesc").text("Official Data - Download");
    }
    else if(chartType == "app_notifications_sent")
    {
        $("#chartDesc").text("Official Data - Notifications sent");
    }
    else if(chartType == "app_positive_users")
    {
        $("#chartDesc").text("Official Data - Positive Users");
    }    

    buildDatasets();
}

function buildDatasets()
{    
    var chartType = $('#chartType').val();
    var timeRange = $('#timeRange').val();

    var xDays = [];    
    if(timeRange === "all")
    {
        for(var day in data.days)
        xDays.push(day);
    }
    else if( (timeRange === "31days") || (timeRange === "7days") )
    {
        dNow = new Date();
        dCur = new Date();
        if(timeRange === "31days")
            dCur.setDate(dNow.getDate()-31);
        else if(timeRange === "7days")
            dCur.setDate(dNow.getDate()-7);
        while(dCur.getTime()<=dNow.getTime())
        {
            xDays.push(dCur.toISOString().split('T')[0])
            dCur.setDate(dCur.getDate()+1);
        }
    }

    chart.data.datasets = [];
    for(var countryCode in data.static.countries)
    {
        var countryData = data.static.countries[countryCode];

        if(countryData.active == false)
            continue;        
        
        if(chartType === "tek")
        {            
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)                
                    if(countryCode in data.days[day])
                        if("nTek" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["nTek"]})
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "dbkeys")
        {            
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)
                    if(countryCode in data.days[day])
                        if("nKeys" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["nKeys"]})
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "new_cases")
        {
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)
                    if(countryCode in data.days[day])
                        if("new_cases" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["new_cases"]})
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "perc_positive_v1")
        {
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                $v = 0;
                if(day in data.days)
                {
                    if(countryCode in data.days[day])
                    {
                        if("nTek" in data.days[day][countryCode]) // Without nTek, don't compute point
                        {
                            if("new_cases" in data.days[day][countryCode]) // Without new_cases, don't compute point
                            {
                                var v=0;

                                if(data.days[day][countryCode]["new_cases"] != 0) // If new_cases==0, compute anyway point
                                {
                                    v = (100*(data.days[day][countryCode]["nTek"]/12)/data.days[day][countryCode]["new_cases"]);                            
                                }

                                dataset.data.push({'x':day,'y':v})
                            }                    
                        }                    
                    }
                }
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "app_download")
        {
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)
                    if(countryCode in data.days[day])
                        if("app_download" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["app_download"]})
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "app_notifications_sent")
        {
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)
                    if(countryCode in data.days[day])
                        if("app_notifications_sent" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["app_notifications_sent"]})
            }

            chart.data.datasets.push(dataset)
        }
        else if(chartType === "app_positive_users")
        {
            var dataset = initDatasetCountry(countryData);
            
            for(var iDay=0;iDay<xDays.length;iDay++)
            {
                var day = xDays[iDay];
                if(day in data.days)
                    if(countryCode in data.days[day])
                        if("app_positive_users" in data.days[day][countryCode])
                            dataset.data.push({'x':day,'y':data.days[day][countryCode]["app_positive_users"]})
            }

            chart.data.datasets.push(dataset)
        }
    }

    chart.update();
}

function main()
{
    chart = new Chart(document.getElementById("chart1").getContext("2d"), {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }]
            }
        }
    });

    $('#chartType').change(function() {
        rebuild();
    })

    $('#timeRange').change(function() {
        rebuild();
    })

    $.ajax({
      url: 'data/current.json',
      method: 'GET',
      success: function(response) {
        data = response;
        console.log(data);        
        rebuild();
      },
      error: function() {
        console.log('Fail, sorry.');
      }
    });
}

main();
    

</script>
</body>
</html>
